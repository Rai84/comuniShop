<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-br">
  <head th:replace="~{fragments/head :: headFragment('Home')}"></head>

  <body class="text-gray-900 bg-gray-100">
    <!-- ================================================================================= -->
    <!-- ===============================  MENU SUPERIOR  ================================= -->
    <!-- ================================================================================= -->
    <header
      class="fixed z-[9999] flex items-center justify-between w-[calc(100vw-2rem)] h-8 bg-gray-100 left-8"
    >
      <div class="flex gap-5 ml-2.5">
        <button class="hover:text-[var(--color-destaque)]">Lojas</button>
        <button class="hover:text-[var(--color-destaque)]">Servi√ßos</button>
      </div>

      <p class="mr-2.5">
        <span th:text="${usuario.logradouro}"></span>
      </p>
    </header>

    <!-- ================================================================================= -->
    <!-- ===============================  BARRA LATERAL  ================================= -->
    <!-- ================================================================================= -->
    <nav
      class="fixed z-[9999] flex flex-col items-center justify-between w-8 h-full bg-gray-600"
    >
      <!-- √çCONES DO MENU LATERAL -->
      <div class="flex flex-col items-center gap-1 pt-4 text-white">
        <i
          onclick="abrirModal('modalPerfil')"
          class="cursor-pointer bi bi-person-circle hover:text-[var(--color-destaque)]"
        ></i>
        <div class="relative">
          <i
            onclick="abrirModalCarrinho()"
            class="text-xl cursor-pointer bi bi-cart2"
          ></i>

          <span
            id="badgeCarrinho"
            class="hidden absolute top-[-0.2rem] right-[-0.2rem] bg-red-600 text-white text-xs font-bold px-0.5 py-0.5 rounded-full"
          >
            0
          </span>
        </div>

        <i
          onclick="abrirModalPedidos()"
          class="cursor-pointer bi bi-receipt-cutoff hover:text-[var(--color-destaque)]"
        ></i>

        <i 
    onclick="abrirModalAgenda()"
    class="cursor-pointer bi bi-calendar-event hover:text-[var(--color-destaque)]"
></i>


        <i
          onclick="abrirModal('modalChat')"
          class="cursor-pointer bi bi-chat-left-dots hover:text-[var(--color-destaque)]"
        ></i>
      </div>

      <!-- BOT√ÉO DO MAPA -->
      <button
        id="abrirMapa"
        class="w-6 h-20 bg-[var(--color-destaque)] rounded-4xl"
      >
        <i class="text-2xl text-white bi bi-geo-alt-fill"></i>
      </button>

      <!-- CONFIGURA√á√ïES -->
      <button
        id="abrirModal"
        class="pb-2.5 text-lg text-white transition hover:text-[var(--color-destaque)]"
      >
        <i class="bi bi-gear-fill"></i>
      </button>
    </nav>

    <!-- ================================================================================= -->
    <!-- ==============================  CONTE√öDO PRINCIPAL  ============================= -->
    <!-- ================================================================================= -->
    <main class="absolute p-10 left-8 w-[calc(100vw-47px)]">
      <!-- ===================== LISTA DE LOJAS COM CAT√ÅLOGO ATIVO ===================== -->
      <h2 class="mb-4 text-xl font-bold">Lojas Dispon√≠veis</h2>

      <div class="grid gap-6 p-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
        <div th:each="entry : ${catalogosPorNegocio}">
          <div
            th:if="${entry.key.catalogoAtivo}"
            class="flex flex-col overflow-hidden bg-white shadow-md rounded-xl"
          >
            <!-- Imagem do painel -->
            <div
              class="relative flex items-center justify-center w-full h-32 bg-gray-200"
            >
              <img
                th:if="${entry.key.painelUrl != null}"
                th:src="${entry.key.painelUrl}"
                class="object-cover w-full h-full"
              />

              <div
                th:if="${entry.key.painelUrl == null}"
                class="w-16 h-16 bg-gray-300 rounded-md"
              ></div>
            </div>

            <!-- Corpo do card -->
            <div class="p-4">
              <!-- Logo + nome da loja -->
              <div class="flex items-center gap-3 mb-3">
                <img
                  th:src="${entry.key.logoUrl != null ? entry.key.logoUrl : '/img/default-logo.png'}"
                  class="object-cover w-12 h-12 border rounded-full"
                />

                <div>
                  <p class="text-sm text-gray-500">Loja</p>
                  <h2
                    class="text-lg font-semibold text-gray-800"
                    th:text="${entry.key.nome}"
                  ></h2>
                </div>
              </div>

              <!-- Descri√ß√£o -->
              <p
                class="mb-3 text-sm text-gray-600"
                th:text="${entry.key.descricao != null ? entry.key.descricao : 'Sem descri√ß√£o dispon√≠vel.'}"
              ></p>

              <!-- Telefone -->
              <p class="mb-4 text-sm text-gray-600">
                üìû <span th:text="${entry.key.telefoneComercial}"></span>
              </p>

              <!-- Hor√°rio -->
              <p class="mb-4 text-sm text-gray-600">
                üïí
                <span
                  th:text="${#strings.substring(entry.key.horaAbertura,0,5)}"
                ></span>
                -
                <span
                  th:text="${#strings.substring(entry.key.horaFechamento,0,5)}"
                ></span>
              </p>

              <!-- Bot√£o -->
              <button
                th:onclick="|abrirModalLoja('${entry.key.id}')|"
                class="..."
              >
                Ver Detalhes
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== LISTA DE PRODUTOS DE LOJAS SEM CAT√ÅLOGO ==================== -->
      <h2 class="mt-10 mb-4 text-xl font-bold">Produtos Dispon√≠veis</h2>

      <div class="grid gap-6 p-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
        <div
          th:each="i : ${itens}"
          th:if="${!i.negocio.catalogoAtivo}"
          class="flex flex-col justify-between overflow-hidden transition-shadow duration-300 bg-white shadow-md rounded-2xl hover:shadow-xl"
        >
          <!-- Imagem -->
          <img
            th:src="${#lists.isEmpty(i.imagens) ? '/img/no-image.png' : i.imagens[0].url}"
            class="object-cover w-full h-48 transition-transform duration-300 hover:scale-105"
          />

          <!-- Informa√ß√µes do produto -->
          <div class="flex flex-col flex-grow p-4">
            <h3
              th:text="${i.nome}"
              class="mb-1 text-lg font-semibold text-gray-900 truncate"
            ></h3>

            <p
              th:text="${i.descricao}"
              class="mb-2 text-sm text-gray-600 line-clamp-2"
            ></p>

            <p class="font-semibold text-gray-700">
              R$
              <span th:text="${#numbers.formatDecimal(i.preco, 1, 2)}"></span>
            </p>

            <button
              th:onclick="|adicionarAoCarrinho(${i.id})|"
              class="inline-block w-full py-2 mt-3 text-sm font-medium text-center text-white bg-green-600 rounded-lg hover:bg-green-700"
            >
              Adicionar ao Carrinho
            </button>
          </div>
        </div>
      </div>

      <!-- ================================================================================= -->
      <!-- ===============================  MODAL √öNICO LOJA ============================== -->
      <!-- ================================================================================= -->
      <div
        id="modalUnico"
        class="fixed inset-0 z-50 flex items-center hidden bg-black/50"
      >
        <div
          id="modalConteiner"
          class="w-[90%] max-w-3xl h-[calc(100vh-3rem)] mt-8 ml-10 overflow-hidden bg-gray-100 rounded-lg shadow-xl transition-all duration-300"
        >
          <!-- Etapa 1: Cat√°logo da loja -->
          <div id="etapa1" class="h-full p-6 overflow-y-auto"></div>

          <!-- Etapa 2: Cat√°logo + Detalhes -->
          <div id="etapa2" class="flex hidden h-full">
            <!-- Lista de itens -->
            <div
              id="colCatalogo"
              class="w-1/2 p-6 overflow-y-auto border-r"
            ></div>

            <!-- Detalhes do item -->
            <div id="colDetalhes" class="w-1/2 p-6 overflow-y-auto"></div>
          </div>

          <!-- Bot√£o fechar -->
          <button
            onclick="fecharModalLoja()"
            class="relative text-2xl text-red-600 hover:text-black top-[-41rem] left-[46rem]"
          >
            &times;
          </button>
        </div>
      </div>
    </main>

    <!-- ================================================================================= -->
    <!-- ===================================  MAPA  ====================================== -->
    <!-- ================================================================================= -->
    <div
      id="modalMapa"
      class="fixed inset-0 z-50 items-center justify-center hidden mt-8 ml-8 bg-black/50"
    >
      <div
        class="relative w-full max-w-3xl p-4 bg-gray-100 rounded-lg shadow-xl"
      >
        <!-- Fechar -->
        <button
          id="fecharMapa"
          class="absolute text-2xl text-gray-600 top-3 right-4 hover:text-gray-900"
        >
          &times;
        </button>

        <h2 class="mb-3 text-xl font-semibold">Mapa</h2>

        <div
          id="map"
          style="height: 600px; width: 100%; border-radius: 10px"
        ></div>
      </div>
    </div>

    <!-- ================================================================================= -->
    <!-- ==============================  MODAIS LATERAIS  ================================= -->
    <!-- ================================================================================= -->

    <!-- ============================== MODAL PERFIL =============================== -->
    <div
      id="modalPerfil"
      class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[9999]"
    >
      <div class="p-6 bg-white shadow-lg w-96 rounded-xl">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold">Meu Perfil</h2>
          <button
            onclick="fecharModal('modalPerfil')"
            class="text-2xl text-gray-600"
          >
            &times;
          </button>
        </div>

        <p class="text-gray-700">Informa√ß√µes do usu√°rio:</p>
        <p class="mt-2 text-gray-700">
          Nome: <span th:text="${usuario.nome}"></span>
        </p>
        <p class="text-gray-700">
          Email: <span th:text="${usuario.email}"></span>
        </p>
        <p class="text-gray-700">
          Telefone: <span th:text="${usuario.telefone}"></span>
        </p>
        <p class="text-gray-700">
          Endere√ßo: <span th:text="${usuario.logradouro}"></span>
        </p>
      </div>
    </div>

    <!-- ============================== MODAL CARRINHO =============================== -->
    <div
      id="modalCarrinho"
      class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[9999]"
    >
      <div class="p-6 bg-white shadow-lg w-96 rounded-xl">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold">Carrinho</h2>
          <button
            onclick="fecharModal('modalCarrinho')"
            class="text-2xl text-gray-600"
          >
            &times;
          </button>
        </div>

        <div id="modalCarrinhoConteudo" class="flex flex-col gap-3"></div>

        <button
          onclick="limparCarrinho()"
          class="w-full py-2 mt-4 text-white bg-red-600 rounded-lg hover:bg-red-700"
        >
          Limpar Carrinho
        </button>

        <button
          onclick="finalizarPedido()"
          class="w-full py-2 mt-2 text-white bg-green-600 rounded-lg hover:bg-green-700"
        >
          Finalizar Pedido
        </button>
      </div>
    </div>

    <!-- ============================== MODAL PEDIDOS =============================== -->

    <div
      id="modalPedidos"
      class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[9999]"
    >
      <div
        class="p-6 bg-white shadow-lg w-96 rounded-xl h-[calc(100vh-3rem)] mt-[2.5rem] ml-10 absolute left-0 top-0"
      >
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold">Pedidos</h2>
          <button
            onclick="fecharModal('modalPedidos')"
            class="text-2xl text-gray-600"
          >
            &times;
          </button>
        </div>

        <div id="listaPedidos" class="flex flex-col gap-3 mt-4"></div>
      </div>
    </div>

    <!-- ============================== MODAL AGENDAMENTOS =============================== -->
    <div
      id="modalAgenda"
      class="fixed inset-0 z-10 flex items-center justify-center hidden bg-black/50"
    >
      <div
        class="p-6 bg-white shadow-lg w-96 rounded-xl h-[calc(100vh-3rem)] mt-[2.5rem] ml-10 absolute left-0 top-0"
      >
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold">Meus Agendamentos</h2>
          <button
            onclick="fecharModal('modalAgenda')"
            class="text-2xl text-gray-600"
          >
            &times;
          </button>
        </div>

        <p class="text-gray-700">Seus agendamentos v√£o aparecer aqui...</p>
        <div id="listaAgendamentos" class="flex flex-col gap-3 mt-4"></div>
      </div>
    </div>

    <!-- ============================== MODAL CHAT =============================== -->
    <div
      id="modalChat"
      class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[9999]"
    >
      <div class="p-6 bg-white shadow-lg w-96 rounded-xl">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold">Chat</h2>
          <button
            onclick="fecharModal('modalChat')"
            class="text-2xl text-gray-600"
          >
            &times;
          </button>
        </div>

        <p class="text-gray-700">Suas conversas v√£o aparecer aqui...</p>
      </div>
    </div>

    <!-- ================================================================================= -->
    <!-- ===============================  SCRIPT CONFIG  ================================= -->
    <!-- ================================================================================= -->
    <script>
      const modalEl = document.getElementById("popup-modal");
      const conteudoModal = document.getElementById("conteudo-modal");

      const modal = new Modal(modalEl, {
        placement: "bottom-left",
        backdrop: "static",
        backdropClasses: "hidden",
        closable: true,
      });

      document
        .getElementById("abrirModal")
        .addEventListener("click", () => modal.show());
      document
        .getElementById("fecharModal")
        ?.addEventListener("click", () => modal.hide());
      document
        .getElementById("fecharModal2")
        ?.addEventListener("click", () => modal.hide());
    </script>

    <!-- ================================================================================= -->
    <!-- ==============================  SCRIPT DO MAPA  ================================= -->
    <!-- ================================================================================= -->

    <script th:inline="javascript">
      /*<![CDATA[*/
      window.lojas = JSON.parse(/*[[${lojasJson}]]*/ "[]");
      console.log("TESTE LOJAS =", window.lojas);
      /*]]>*/
    </script>

    <script>
      /* ========================================================= */
      /* ============ FUN√á√ÉO: ABRIR MODAL DA LOJA ================= */
      /* ========================================================= */

      function abrirModalLoja(lojaId) {
        const loja = lojas.find((l) => l.id == lojaId);

        if (!loja) {
          console.error("Loja n√£o encontrada:", lojaId);
          return;
        }

        let html = `
              <h2 class="mb-4 text-2xl font-bold">${loja.nome}</h2>
              <p class="mb-4 text-gray-600">üïí ${loja.horaAbertura} - ${loja.horaFechamento}</p>
              <div class="grid gap-4 sm:grid-cols-2">
          `;

        loja.itens.forEach((i) => {
          const img = i.imagens[0] || "/img/no-image.png";

          html += `
                  <div class="p-3 border rounded-lg shadow cursor-pointer"
                       onclick="abrirItem(${loja.id}, ${i.id})">

                      <img src="${img}" class="object-cover w-full h-32 mb-2 rounded">
                      <h3 class="font-semibold">${i.nome}</h3>
                      <p class="text-sm text-gray-600">${i.descricao}</p>
                      <p class="mt-2 font-bold">R$ ${i.preco}</p>
                  </div>
              `;
        });

        html += "</div>";

        document.getElementById("etapa1").innerHTML = html;

        document.getElementById("etapa1").classList.remove("hidden");
        document.getElementById("etapa2").classList.add("hidden");
        document.getElementById("modalConteiner").classList.add("max-w-3xl");

        document.getElementById("modalUnico").classList.remove("hidden");
      }

      /* ========================================================= */
      /* ===================== ABRIR ITEM ========================= */
      /* ========================================================= */

      function abrirItem(lojaId, itemId) {
        const loja = lojas.find((l) => l.id == lojaId);
        const item = loja.itens.find((i) => i.id == itemId);

        /* === CAT√ÅLOGO ESQUERDA === */
        let cat = `
              <h2 class="mb-2 text-xl font-bold">${loja.nome}</h2>
              <p class="mb-4 text-sm text-gray-600">üïí ${loja.horaAbertura} - ${
          loja.horaFechamento
        }</p>
              <p class="mb-4 text-sm text-gray-600">Agendamentos: ${
                loja.agendamentoAtivo ? "Sim" : "N√£o"
              }</p>
          `;

        loja.itens.forEach((i) => {
          cat += `
                  <div class="p-2 border-b cursor-pointer hover:bg-gray-100"
                       onclick="abrirItem(${loja.id}, ${i.id})">
                       ${i.nome}
                  </div>
              `;
        });

        document.getElementById("colCatalogo").innerHTML = cat;

        /* === DETALHES DO ITEM === */
        let det = `
              <h2 class="mb-4 text-2xl font-bold">${item.nome}</h2>
              <p><strong>Descri√ß√£o:</strong> ${item.descricao}</p>
              <p><strong>Pre√ßo:</strong> R$ ${item.preco}</p>
              <p><strong>Dura√ß√£o:</strong> ${item.duracao ?? "‚Äì"} min</p>

              <h3 class="mt-4 text-lg font-semibold">Imagens</h3>
              <div class="grid grid-cols-2 gap-4">
          `;

        item.imagens.forEach((img) => {
          det += `<img src="${img}" class="w-full h-40 rounded">`;
        });

        det += `</div>`;

        /* ------- SISTEMA DE AGENDAMENTO ------- */
        if (loja.agendamentoAtivo) {
          det += `
                  <h3 class="mt-6 mb-2 text-lg font-semibold">Agendamento</h3>

                  <label class="block mb-2 text-sm text-gray-700">Selecione uma data:</label>
                  <input type="date" id="dataAgendamento"
                         class="w-full p-2 mb-4 border rounded"
                         onchange="gerarHorarios(${lojaId}, ${itemId})">

                  <div id="horariosContainer"></div>

                  <div class="mt-6">
                      <button
                          onclick="confirmarAgendamento()"
                          class="w-full p-3 text-white bg-green-600 rounded hover:bg-green-700">
                          Confirmar Agendamento
                      </button>
                  </div>
              `;
        }

        document.getElementById("colDetalhes").innerHTML = det;

        document.getElementById("etapa1").classList.add("hidden");
        document.getElementById("etapa2").classList.remove("hidden");
        document.getElementById("modalConteiner").classList.add("max-w-5xl");
      }

      /* ========================================================= */
      /* ================ FUN√á√ÉO: GERAR HOR√ÅRIOS ================== */
      /* ========================================================= */

      function gerarHorarios(lojaId, itemId) {
        const loja = lojas.find((l) => l.id == lojaId);
        const item = loja.itens.find((i) => i.id == itemId);

        const duracao = item.duracao || 30;
        const data = document.getElementById("dataAgendamento").value;

        if (!data) {
          document.getElementById("horariosContainer").innerHTML =
            "<p class='col-span-3 text-red-600'>Selecione uma data.</p>";
          return;
        }

        let inicio = loja.horaAbertura.substring(0, 5);
        let fim = loja.horaFechamento.substring(0, 5);

        let [h, m] = inicio.split(":").map(Number);
        let [hFim, mFim] = fim.split(":").map(Number);

        let horarios = [];

        // --- CORRE√á√ÉO: hor√°rio que vira madrugada ---
        let passaMeiaNoite = false;
        if (hFim < h || (hFim === h && mFim < m)) {
          passaMeiaNoite = true;
        }

        // --- HOR√ÅRIOS DO DIA NORMAL ---
        while (h < 24 || (h === 23 && m < 60)) {
          const horaFormatada = `${String(h).padStart(2, "0")}:${String(
            m
          ).padStart(2, "0")}`;
          horarios.push(horaFormatada);

          m += duracao;
          if (m >= 60) {
            m -= 60;
            h++;
          }
          if (!passaMeiaNoite && h === hFim && m > mFim) break;
        }

        // --- COMPLETA DO OUTRO DIA SE PASSA A MEIA NOITE ---
        if (passaMeiaNoite) {
          h = 0;
          m = 0;
          while (h < hFim || (h === hFim && m <= mFim)) {
            const horaFormatada = `${String(h).padStart(2, "0")}:${String(
              m
            ).padStart(2, "0")}`;
            horarios.push(horaFormatada);

            m += duracao;
            if (m >= 60) {
              m -= 60;
              h++;
            }
          }
        }

        renderizarHorarios(horarios, lojaId, itemId, duracao);
      }

      /* ========================================================= */
      /* ============== FUN√á√ÉO: EXIBIR HOR√ÅRIOS ================== */
      /* ========================================================= */

      function renderizarHorarios(lista, lojaId, itemId, duracao) {
    let html = `
        <div class="flex flex-row flex-wrap items-center w-full gap-2">
    `;

    lista.forEach((hora) => {
        html += `
            <div 
                class="px-4 py-2 text-gray-700 transition bg-white border rounded-full cursor-pointer horario-btn hover:bg-gray-200"
                data-hora="${hora}"
                onclick="selecionarHorario(this, '${lojaId}', '${itemId}', '${hora}', ${duracao})">
                ${hora}
            </div>
        `;
    });

    html += `</div>`;

    document.getElementById("horariosContainer").innerHTML = html;
}


      /* ========================================================= */
      /* ============== FUN√á√ÉO: ESCOLHER HOR√ÅRIO ================= */
      /* ========================================================= */

      function selecionarHorario(btn, lojaId, itemId, horaInicio, duracao) {
        // Remove destaque de todas as barras
        document.querySelectorAll(".horario-btn").forEach((b) => {
          b.classList.remove("bg-green-600", "text-white");
          b.classList.add("bg-white", "text-gray-700");
        });

        // Ativa destaque na selecionada
        btn.classList.remove("bg-white", "text-gray-700");
        btn.classList.add("bg-green-600", "text-white");

        // Calcula hora fim
        const [h, m] = horaInicio.split(":").map(Number);
        const totalMinutos = h * 60 + m + duracao;

        const horaFimH = String(Math.floor(totalMinutos / 60)).padStart(2, "0");
        const horaFimM = String(totalMinutos % 60).padStart(2, "0");
        const horaFim = `${horaFimH}:${horaFimM}`;

        // Salva agendamento
        window.agendamentoSelecionado = {
          lojaId,
          itemId,
          data: document.getElementById("dataAgendamento").value,
          horaInicio,
          horaFim,
          duracao,
        };
      }

      /* ========================================================= */
      /* ============== FUN√á√ÉO: CONFIRMAR AGENDAMENTO ============ */
      /* ========================================================= */

      function confirmarAgendamento() {
        if (!window.agendamentoSelecionado) {
          alert("Selecione um hor√°rio antes de confirmar.");
          return;
        }

        fetch("/agendamentos/salvar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(window.agendamentoSelecionado),
        })
          .then((r) => r.json())
          .then(() => {
            alert("Agendamento confirmado!");
            fecharModalLoja();
          })
          .catch(() => alert("Erro ao salvar agendamento."));
      }

      // ===========================
      // ADICIONAR AO CARRINHO
      // ===========================
      function adicionarAoCarrinho(itemId) {
        fetch("/carrinho/adicionar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ itemId }),
        })
          .then((r) => r.json())
          .then(() => {
            carregarCarrinho();
            atualizarBadgeCarrinho();
            abrirModalCarrinho();
          })
          .catch(() => alert("Erro ao adicionar ao carrinho."));
      }

      // ===========================
      // CARREGAR CARRINHO
      // ===========================
      function carregarCarrinho() {
        fetch("/carrinho/listar")
          .then((r) => r.json())
          .then((lista) => {
            const c = document.getElementById("modalCarrinhoConteudo");
            c.innerHTML = "";

            if (!lista || lista.length === 0) {
              c.innerHTML = "<p class='text-gray-600'>Carrinho vazio.</p>";
              return;
            }

            lista.forEach((item) => {
              c.innerHTML += `
                    <div class="flex items-center justify-between p-2 border-b">

                        <div class="flex items-center gap-3">
                            <img src="${item.imagem}" class="w-12 h-12 rounded">
                            <div>
                                <p class="font-semibold">${item.nome}</p>
                                <p class="text-sm text-gray-600">R$ ${item.preco}</p>
                                <p class="text-sm">Qtd: ${item.quantidade}</p>
                            </div>
                            <div class="flex items-center gap-2">
    <button onclick="alterarQtd(${item.id}, -1)"
        class="px-2 py-1 text-lg font-bold text-white bg-red-600 rounded hover:bg-red-700">‚àí</button>

    <span class="px-3 py-1 bg-gray-200 rounded">${item.quantidade}</span>

    <button onclick="alterarQtd(${item.id}, +1)"
        class="px-2 py-1 text-lg font-bold text-white bg-green-600 rounded hover:bg-green-700">+</button>
</div>

                        </div>

                        <button onclick="removerItem(${item.id})"
                            class="text-xl text-red-600 hover:text-red-900">
                            &times;
                        </button>
                    </div>
                `;
            });
          });
      }

      // ===========================
      // REMOVER ITEM
      // ===========================
      function removerItem(id) {
        fetch("/carrinho/remover", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ itemId: id }),
        })
          .then((r) => r.json())
          .then(() => carregarCarrinho())
          .then(() => atualizarBadgeCarrinho());
      }

      // ===========================
      // LIMPAR CARRINHO
      // ===========================
      function limparCarrinho() {
        fetch("/carrinho/limpar", { method: "POST" }).then(() => {
          carregarCarrinho();
          atualizarBadgeCarrinho();
        });
      }

      // ===========================
      // ALTERAR QUANTIDADE

      function alterarQtd(id, delta) {
        fetch("/carrinho/alterar-quantidade", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ itemId: id, delta }),
        })
          .then((r) => r.json())
          .then(() => carregarCarrinho())
          .then(() => atualizarBadgeCarrinho())
          .catch(() => alert("Erro ao atualizar quantidade"));
      }

      function atualizarBadgeCarrinho() {
        fetch("/carrinho/listar")
          .then((r) => r.json())
          .then((lista) => {
            const badge = document.getElementById("badgeCarrinho");

            if (!lista || lista.length === 0) {
              badge.classList.add("hidden");
              return;
            }

            let totalQtd = lista.reduce(
              (soma, item) => soma + item.quantidade,
              0
            );

            badge.innerText = totalQtd;
            badge.classList.remove("hidden");
          });
      }

      function finalizarPedido() {
        fetch("/carrinho/finalizar", { method: "POST" })
          .then((r) => r.json())
          .then((resp) => {
            if (resp.erro) {
              alert(resp.erro);
              return;
            }

            alert("Pedido realizado! ID: " + resp.pedidoId);
            carregarCarrinho();
            atualizarBadgeCarrinho();
            fecharModal("modalCarrinho");
          })
          .catch(() => alert("Erro ao finalizar pedido"));
      }

      // ===========================
      // ABRIR MODAL DO CARRINHO
      // ===========================
      function abrirModalCarrinho() {
        carregarCarrinho();
        atualizarBadgeCarrinho();
        document.getElementById("modalCarrinho").classList.remove("hidden");
      }

      function fecharModalLoja() {
        atualizarBadgeCarrinho();
        document.getElementById("modalUnico").classList.add("hidden");
      }

      function abrirModalPedidos() {
        fetch("/pedidos/meus")
          .then((r) => r.json())
          .then((lista) => {
            const container = document.getElementById("listaPedidos");
            container.innerHTML = "";

            if (!lista || lista.length === 0) {
              container.innerHTML =
                "<p class='text-center text-gray-600'>Voc√™ ainda n√£o possui pedidos.</p>";
              document
                .getElementById("modalPedidos")
                .classList.remove("hidden");
              return;
            }

            lista.forEach((pedido) => {
              const itensHTML = pedido.itens
                .map(
                  (i) => `
                        <div class="flex justify-between text-sm">
                            <span>${i.nome} (x${i.quantidade})</span>
                            <span>R$ ${i.precoUnitario}</span>
                        </div>
                    `
                )
                .join("");

              container.innerHTML += `
                    <div class="p-4 bg-white border shadow-sm rounded-xl">
                        
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-800">
                                Pedido #${pedido.id}
                            </h3>
                            <span class="px-2 py-1 text-xs text-blue-700 bg-blue-100 rounded-full">
                                ${pedido.status}
                            </span>
                        </div>

                        <p class="mt-1 text-sm text-gray-500">
                            Loja: <strong>${pedido.loja}</strong>
                        </p>

                        <div class="p-2 mt-3 bg-gray-100 rounded-lg">
                            ${itensHTML}
                        </div>

                        <p class="mt-3 font-semibold text-right">
                            Total: R$ ${pedido.total}
                        </p>
                    </div>
                `;
            });

            document.getElementById("modalPedidos").classList.remove("hidden");
          })
          .catch((err) => {
            console.error("Erro ao carregar pedidos:", err);
            alert("Erro ao carregar seus pedidos.");
          });
      }
    </script>

    <!-- ================================================================================= -->
    <!-- =================== FUN√á√ïES GERAIS PARA ABRIR/FECHAR MODAIS ===================== -->
    <!-- ================================================================================= -->
    <script>
      function abrirModal(id) {
        document.getElementById(id).classList.remove("hidden");
      }

      function fecharModal(id) {
        document.getElementById(id).classList.add("hidden");
      }
    </script>

    <script>
      function abrirModalAgenda() {
        fetch("/agendamentos/meus")
          .then((r) => r.json())
          .then((lista) => {
            const container = document.getElementById("listaAgendamentos");
            container.innerHTML = "";

            if (!lista || lista.length === 0) {
              container.innerHTML =
                "<p class='text-center text-gray-600'>Voc√™ ainda n√£o possui agendamentos.</p>";
              document.getElementById("modalAgenda").classList.remove("hidden");
              return;
            }

            lista.forEach((a) => {
              const card = `
                    <div class="flex flex-col gap-1 p-4 bg-white border shadow-sm rounded-xl">
                        
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-800">${a.item}</h3>
                            <span class="px-2 py-1 text-xs text-blue-700 bg-blue-100 rounded-full">
                                ${a.data}
                            </span>
                        </div>

                        <p class="flex items-center gap-1 text-sm text-gray-500">
                            <i class="bi bi-shop"></i> ${a.negocio}
                        </p>

                        <div class="flex items-center justify-between p-2 mt-2 bg-gray-100 rounded-lg">
                            <span class="font-medium text-green-700">
                                ‚è± ${a.horaInicio} ‚Üí ${a.horaFim}
                            </span>

                            <span class="text-sm text-gray-600">
                                ${a.duracaoMinutos} min
                            </span>
                        </div>

                    </div>
                `;

              container.innerHTML += card;
            });

            document.getElementById("modalAgenda").classList.remove("hidden");
          })
          .catch((err) => {
            console.error("Erro ao carregar agendamentos:", err);
            alert("Erro ao carregar seus agendamentos.");
          });
      }
    </script>
  </body>
</html>
