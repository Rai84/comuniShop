<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-br">
<head th:replace="~{fragments/head :: headFragment('Home')}"></head>

<body class="text-gray-900 bg-gray-100">

  <!-- MENU SUPERIOR -->
  <div th:replace="~{fragments/menuHome :: menuFragment}"></div>

  <!-- BARRA LATERAL -->
  <nav class="w-8 h-[calc(100vh-40px)] bg-gray-600 fixed flex items-center justify-between flex-col top-10">
    <div class="flex flex-col items-center gap-1 pt-4 text-white">
      <i class="bi bi-box"></i>
      <i class="bi bi-box"></i>
      <i class="bi bi-box"></i>
      <i class="bi bi-box"></i>
    </div>

    <button id="abrirMapa" class="w-6 h-20 bg-[--color-destaque] rounded-4xl">
      <i class="text-2xl text-white bi bi-geo-alt-fill"></i>
    </button>

    <button id="abrirModal" class="text-lg text-white transition hover:text-[--color-destaque] pb-2.5">
      <i class="bi bi-gear-fill"></i>
    </button>
  </nav>

  <!-- CONTEÃšDO -->
  <div class="w-[calc(100vw-47px)] absolute left-8 p-10">

    <!-- =============== LOJAS COM CATALOGO ATIVO =============== -->
    <h2 class="text-xl font-bold mb-4">Lojas DisponÃ­veis</h2>

    <div class="grid gap-6 p-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">

      <div th:each="entry : ${catalogosPorNegocio}">
        <div th:if="${entry.key.catalogoAtivo}" class="p-4 bg-white shadow-md rounded-xl flex flex-col justify-between">

          <h2 class="text-lg font-semibold text-gray-800" th:text="${entry.key.nome}"></h2>

          <p class="text-sm text-gray-600 mt-1">
            ðŸ•’ 
            <span th:text="${entry.key.horaAbertura}"></span> -
            <span th:text="${entry.key.horaFechamento}"></span>
          </p>

          <button
            th:data-modal-target="'modalLoja_' + ${entry.key.id}"
            th:data-modal-toggle="'modalLoja_' + ${entry.key.id}"
            class="w-full py-2 mt-4 bg-destaque text-black rounded-lg hover:bg-destaque2">
            Ver Itens
          </button>

        </div>
      </div>

    </div>

    <!-- =============== ITENS DE LOJAS SEM CATALOGO =============== -->
    <h2 class="text-xl font-bold mt-10 mb-4">Produtos DisponÃ­veis</h2>

    <div class="grid gap-6 p-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">

      <div th:each="i : ${itens}" th:if="${!i.negocio.catalogoAtivo}"
           class="flex flex-col justify-between overflow-hidden transition-shadow duration-300 bg-white shadow-md rounded-2xl hover:shadow-xl">

        <img th:src="${#lists.isEmpty(i.imagens) ? '/img/no-image.png' : i.imagens[0].url}"
             class="object-cover w-full h-48 transition-transform duration-300 hover:scale-105">

        <div class="flex flex-col flex-grow p-4">

          <h3 th:text="${i.nome}" class="mb-1 text-lg font-semibold text-gray-900 truncate"></h3>

          <p th:text="${i.descricao}" class="mb-2 text-sm text-gray-600 line-clamp-2"></p>

          <p class="font-semibold text-gray-700">
            R$ <span th:text="${#numbers.formatDecimal(i.preco, 1, 2)}"></span>
          </p>

          <button
            th:data-modal-target="'modalItem_' + ${i.id}"
            th:data-modal-toggle="'modalItem_' + ${i.id}"
            class="inline-block w-full py-2 mt-3 text-sm font-medium text-center text-black bg-destaque rounded-lg hover:bg-destaque2">
            Ver Detalhes
          </button>

        </div>
      </div>

    </div>

    <!-- =============== MODAIS DE ITENS (Catalogo) =============== -->
    <div th:each="i : ${itens}"
         th:id="'modalItem_' + ${i.id}"
         class="fixed inset-0 z-50 hidden bg-black/50 flex items-center justify-center">

      <div class="w-full max-w-2xl p-6 bg-white rounded-lg shadow-lg overflow-y-auto max-h-[90vh]">

        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold" th:text="${i.nome}"></h2>

          <button th:data-modal-hide="'modalItem_' + ${i.id}" class="text-2xl text-gray-600 hover:text-gray-800">&times;</button>
        </div>

        <p><strong>DescriÃ§Ã£o:</strong> <span th:text="${i.descricao}"></span></p>
        <p><strong>PreÃ§o:</strong> R$ <span th:text="${#numbers.formatDecimal(i.preco,1,2)}"></span></p>
        <p><strong>NegÃ³cio:</strong> <span th:text="${i.negocio.nome}"></span></p>

        <h3 class="mt-4 mb-2 font-semibold text-lg">Imagens</h3>

        <div th:if="${i.imagens != null && !i.imagens.isEmpty()}"
             class="grid grid-cols-2 gap-4">
          <div th:each="img : ${i.imagens}" class="p-2 bg-gray-100 border rounded-lg">
            <img th:src="${img.url}" class="object-cover w-full h-40 rounded-md">
          </div>
        </div>

        <div th:if="${i.imagens == null || i.imagens.isEmpty()}" class="text-sm text-gray-500">
          Nenhuma imagem cadastrada.
        </div>

        <button th:data-modal-hide="'modalItem_' + ${i.id}"
                class="mt-6 px-4 py-2 text-white rounded-lg bg-destaque hover:bg-destaque2 w-full">
          Fechar
        </button>

      </div>
    </div>

    <!-- =============== MODAIS DAS LOJAS =============== -->
    <div th:each="entry : ${catalogosPorNegocio}">
      <div th:if="${entry.key.catalogoAtivo}"
           th:id="'modalLoja_' + ${entry.key.id}"
           class="fixed inset-0 z-50 hidden bg-black/50 flex items-center justify-center">

        <div class="max-w-3xl w-full bg-white p-6 rounded-lg shadow-lg max-h-[90vh] overflow-y-auto">

          <div class="flex justify-between mb-4">
            <h2 class="text-xl font-bold" th:text="${entry.key.nome}"></h2>
            <button th:data-modal-hide="'modalLoja_' + ${entry.key.id}"
                    class="text-gray-600 text-2xl hover:text-black">&times;</button>
          </div>

          <p class="mb-4 text-gray-600">
            ðŸ•’ HorÃ¡rio: 
            <span th:text="${entry.key.horaAbertura}"></span> - 
            <span th:text="${entry.key.horaFechamento}"></span>
          </p>

          <!-- LISTA DE ITENS DO NEGÃ“CIO -->
          <div class="grid gap-4 sm:grid-cols-2">

            <div th:each="i : ${entry.value}" class="border p-3 rounded-lg shadow">

              <img th:src="${#lists.isEmpty(i.imagens) ? '/img/no-image.png' : i.imagens[0].url}"
                   class="w-full h-32 object-cover rounded mb-2">

              <h3 class="font-semibold" th:text="${i.nome}"></h3>

              <p class="text-sm text-gray-600 line-clamp-2" th:text="${i.descricao}"></p>

              <p class="font-bold mt-2">
                R$ <span th:text="${#numbers.formatDecimal(i.preco,1,2)}"></span>
              </p>

              <button
                th:data-modal-target="'modalItem_' + ${i.id}"
                th:data-modal-toggle="'modalItem_' + ${i.id}"
                class="w-full py-2 mt-2 text-sm bg-destaque rounded-lg hover:bg-destaque2">
                Ver Detalhes
              </button>

            </div>
          </div>

        </div>

      </div>
    </div>

  </div><!-- FIM CONTEÃšDO -->


  <!-- =============== SCRIPT CONFIGURAÃ‡Ã•ES =============== -->
  <script>
    const modalEl = document.getElementById('popup-modal');
    const conteudoModal = document.getElementById('conteudo-modal');

    const modal = new Modal(modalEl, {
      placement: 'bottom-left',
      backdrop: 'static',
      backdropClasses: 'hidden',
      closable: true
    });

    document.getElementById('abrirModal').addEventListener('click', () => modal.show());
    document.getElementById('fecharModal').addEventListener('click', () => modal.hide());
    document.getElementById('fecharModal2').addEventListener('click', () => modal.hide());
  </script>


  <!-- =============== SCRIPT DO MAPA =============== -->
  <script th:inline="javascript">
    const abrirMapa = document.getElementById("abrirMapa");
    const modalMapa = document.getElementById("modalMapa");
    const fecharMapa = document.getElementById("fecharMapa");

    abrirMapa.onclick = () => {
      modalMapa.classList.remove("hidden");
      setTimeout(initMap, 100);
    };

    fecharMapa.onclick = () => modalMapa.classList.add("hidden");
    modalMapa.onclick = (e) => { if (e.target === modalMapa) modalMapa.classList.add("hidden"); };

    const usuarioLat = /*[[${usuario.latitude}]]*/ 0;
    const usuarioLng = /*[[${usuario.longitude}]]*/ 0;

    const negocios = [
      /*[# th:each="i : ${itens}"]*/
      {
        nome: '[[${i.negocio.nome}]]',
        lat: '[[${i.negocio.latitude}]]',
        lng: '[[${i.negocio.longitude}]]'
      },
      /*[/]*/
    ];

    let map;
    function initMap() {
      map = L.map('map').setView([usuarioLat, usuarioLng], 14);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
      }).addTo(map);

      L.marker([usuarioLat, usuarioLng]).bindPopup("VocÃª estÃ¡ aqui").addTo(map);

      negocios.forEach(n => {
        if (n.lat && n.lng) {
          L.marker([n.lat, n.lng]).bindPopup(n.nome).addTo(map);
        }
      });
    }
  </script>

</body>
</html>
